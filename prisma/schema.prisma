// Clara Backend Database Schema
// Using Neon PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Conversation tracks a chat session
model Conversation {
  id           String    @id @default(cuid())
  sessionId    String    // Browser session identifier
  currentPage  String?   // Page visitor is on
  startedAt    DateTime  @default(now())
  lastActivity DateTime  @updatedAt

  // Qualification tracking
  leadScore    Int       @default(0)
  leadQuality  String    @default("unknown") // hot, warm, cold, unknown

  // Context gathered during conversation
  context      Json?     // Stores company info, role, etc.

  // Experiment tracking
  experimentId String?
  variantId    String?

  // Relations
  messages     Message[]
  lead         Lead?     @relation(fields: [leadId], references: [id])
  leadId       String?
  outcome      ConversationOutcome?

  @@index([sessionId])
  @@index([startedAt])
}

// Individual messages in a conversation
model Message {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  role           String       // 'user' | 'assistant'
  content        String       @db.Text

  // Tool usage tracking
  toolCalls      Json?        // Tool calls made in this message
  toolResults    Json?        // Results from tool calls

  createdAt      DateTime     @default(now())

  @@index([conversationId])
  @@index([createdAt])
}

// Lead information captured during conversations
model Lead {
  id            String   @id @default(cuid())

  // Contact info (all optional for partial leads)
  email         String?  @unique
  firstName     String?
  lastName      String?
  phone         String?

  // Company info
  company       String?
  companySize   String?  // e.g., "500-1000"
  industry      String?
  website       String?

  // Role and authority
  role          String?
  roleLevel     String?  // C-Suite, Director, Manager, etc.

  // Interest and qualification
  primaryInterest    String?  // ai-assessment, outsourced-ld, consulting, training
  secondaryInterests String[] // Additional interests

  // Lead scoring
  companyFitScore    Int      @default(0)  // Max 40
  authorityScore     Int      @default(0)  // Max 30
  intentScore        Int      @default(0)  // Max 30
  totalScore         Int      @default(0)  // Max 100
  quality            String   @default("unknown") // hot (70+), warm (40-69), cold (<40)

  // Discovery information
  painPoints         String[] // Specific challenges mentioned
  hesitations        String[] // Concerns expressed
  decisionCriteria   String[] // What will drive their decision
  otherStakeholders  String[] // Other people involved
  timeline           String?  // When they want to act

  // Conversation summary
  conversationSummary String?  @db.Text
  keyMoments          String[] // Important conversation moments
  infoRequested       String[] // Additional info they wanted
  recommendedApproach String?  @db.Text // How to approach follow-up

  // Source tracking
  source        String?  // Where they came from
  utmSource     String?
  utmMedium     String?
  utmCampaign   String?

  // Status
  status        String   @default("incomplete") // incomplete, complete, scheduled, contacted
  scheduledAt   DateTime? // If they booked a meeting
  contactedAt   DateTime? // When sales followed up

  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  conversations Conversation[]

  @@index([email])
  @@index([quality])
  @@index([status])
  @@index([createdAt])
}

// ===========================================
// Learning System Models
// ===========================================

// Experiment for A/B testing prompt variations
model Experiment {
  id          String    @id @default(cuid())
  name        String
  description String?   @db.Text
  status      String    @default("draft") // draft, active, paused, completed
  targetSize  Int?      // Target number of conversations
  startedAt   DateTime?
  endedAt     DateTime?
  createdAt   DateTime  @default(now())

  // Relations
  variants    Variant[]

  @@index([status])
}

// Variant within an experiment
model Variant {
  id           String     @id @default(cuid())
  experimentId String
  experiment   Experiment @relation(fields: [experimentId], references: [id], onDelete: Cascade)
  name         String
  description  String?    @db.Text
  promptDiff   Json       // JSON object describing prompt modifications
  weight       Int        @default(50) // Traffic allocation weight (percentage)

  // Relations
  outcomes     ConversationOutcome[]
  dailyMetrics DailyMetrics[]

  @@index([experimentId])
}

// Outcome tracking for conversations in experiments
model ConversationOutcome {
  id              String       @id @default(cuid())
  conversationId  String       @unique
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  variantId       String?
  variant         Variant?     @relation(fields: [variantId], references: [id], onDelete: Cascade)
  outcome         String       // scheduled, qualified, interested, bounced
  outcomeAt       DateTime
  messageCount    Int          @default(0)
  durationSec     Int          @default(0)
  visitorRole     String?
  companySize     String?
  industry        String?
  primaryInterest String?
  createdAt       DateTime     @default(now())

  @@index([outcome])
  @@index([variantId])
}

// Calendly event tracking
model CalendlyEvent {
  id              String   @id @default(cuid())
  calendlyEventId String   @unique
  conversationId  String?
  email           String
  eventType       String
  scheduledAt     DateTime
  status          String   @default("scheduled") // scheduled, completed, canceled, no_show
  createdAt       DateTime @default(now())

  @@index([email])
  @@index([conversationId])
}

// Daily aggregated metrics per variant
model DailyMetrics {
  id             String   @id @default(cuid())
  date           DateTime @db.Date
  variantId      String
  variant        Variant  @relation(fields: [variantId], references: [id], onDelete: Cascade)
  conversations  Int      @default(0)
  scheduled      Int      @default(0)
  qualified      Int      @default(0)
  interested     Int      @default(0)
  bounced        Int      @default(0)
  avgMessages    Float    @default(0)
  avgDurationSec Float    @default(0)

  @@unique([date, variantId])
  @@index([date])
}
